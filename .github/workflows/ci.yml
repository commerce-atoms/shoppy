name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Test & Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Verify (typecheck + lint + test + build + pack)
        run: npm run verify

      - name: Verify no uncommitted build artifacts
        run: |
          git diff --exit-code || (echo "Error: Uncommitted changes detected after build. Ensure dist/ is in .gitignore and not committed." && exit 1)

  consumer-smoke-test:
    name: Consumer Smoke Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: npm run build

      - name: Pack packages
        run: |
          mkdir -p /tmp/tarballs
          cd packages/urlstate && npm pack && mv *.tgz /tmp/tarballs/
          cd ../variants && npm pack && mv *.tgz /tmp/tarballs/

      - name: Test consumer imports
        run: |
          mkdir -p /tmp/consumer-test
          cd /tmp/consumer-test

          # Create package.json with type: module
          echo '{"type": "module"}' > package.json

          # Install packed packages
          npm install /tmp/tarballs/*.tgz

          # Create runtime test file
          cat > test-runtime.mjs << 'EOF'
          import {toggleFilter} from '@commerce-atoms/urlstate/filters/toggleFilter';
          import {findVariant} from '@commerce-atoms/variants/findVariant';

          // Runtime execution test
          const state = {filters: {}};
          const result = toggleFilter(state, 'color', 'red');

          if (!result.filters || !result.filters.color || result.filters.color[0] !== 'red') {
            throw new Error('toggleFilter failed runtime test');
          }

          console.log('âœ… Consumer imports work correctly');
          EOF

          # Runtime execution test (Node ESM)
          node test-runtime.mjs
